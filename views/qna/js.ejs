<% if (user && user.local.accountType==='admin') { %>
<script src="/javascript/ckeditor/ckeditor.js"></script>
<% } %>
<script>
$(document).ready(function() {

  var hash = location.hash;
  if (hash === "#hot") {
    $('div.qa-hot').fadeIn(500);
    $('div.qa-all').hide();

  } else if (hash === "#all") {
    $('div.qa-hot').hide();
    $('div.qa-all').hide().fadeIn(500);
    $('.qa-school').show();
    $('.qa-student').show();
    $('.qa-dorm').show();
    $('.qa-other').show();
    $('#title-all').show();
    $('#title-school').hide();
    $('#title-student').hide();
    $('#title-dorm').hide();
    $('#title-other').hide();

  } else if (hash === "#school") {
    $('div.qa-hot').hide();
    $('div.qa-all').hide().fadeIn(500);
    $('tr.qa-school').show();
    $('tr.qa-student').hide();
    $('tr.qa-dorm').hide();
    $('tr.qa-other').hide();
    $('#title-all').hide();
    $('#title-school').show();
    $('#title-student').hide();
    $('#title-dorm').hide();
    $('#title-other').hide();

  } else if (hash === "#student") {
    $('div.qa-hot').hide();
    $('div.qa-all').hide().fadeIn(500);
    $('tr.qa-school').hide();
    $('tr.qa-student').show();
    $('tr.qa-dorm').hide();
    $('tr.qa-other').hide();
    $('#title-all').hide();
    $('#title-school').hide();
    $('#title-student').show();
    $('#title-dorm').hide();
    $('#title-other').hide();

  } else if (hash === "#dorm") {
    $('div.qa-hot').hide();
    $('div.qa-all').hide().fadeIn(500);
    $('tr.qa-school').hide();
    $('tr.qa-student').hide();
    $('tr.qa-dorm').show();
    $('tr.qa-other').hide();
    $('#title-all').hide();
    $('#title-school').hide();
    $('#title-student').hide();
    $('#title-dorm').show();
    $('#title-other').hide();

  } else if (hash === "#other") {
    $('div.qa-hot').hide();
    $('div.qa-all').hide().fadeIn(500);
    $('tr.qa-school').hide();
    $('tr.qa-student').hide();
    $('tr.qa-dorm').hide();
    $('tr.qa-other').show();
    $('#title-all').hide();
    $('#title-school').hide();
    $('#title-student').hide();
    $('#title-dorm').hide();
    $('#title-other').show();
  } else {
    $('div.qa-hot').hide().fadeIn(500);
    if (hash === "#post") {
      $('#post').modal('show');
    }
  }

  <%# 當發問成功會轉址到 /qna/?post=success 時，顯示發問成功的 modal %>
  <% if (user) { %>
    var strUrl = location.search;
    if (strUrl.indexOf('?') !== -1) {
      var getSearch = strUrl.split('?');
      var getString = getSearch[1];
      if (getString.indexOf('&') === -1) {
        var getAll = getString.split('=');
        if (getAll[0] === 'post' && getAll[1] === 'success') {
          $('#success').modal('show');
        } else if (getAll[0] === 'delete' && getAll[1] === 'success') {
          $('#delete-success').modal('show');
        }
      }
    }
  <% } %>

  <%# Logo放大縮小 %>
  $('#logo').on('mouseover', function(){
    $(this).css('width', '95%');
  });

  $('#logo').on('mouseout', function(){
    $(this).css('width', '90%');
  });

  <%# 側導覽列顯示動畫 %>
  $('.nav-toggle-btn').on('click', function(e) {
    $(this).children('i').toggleClass('fa-chevron-circle-right').toggleClass('fa-chevron-circle-left');
    $('#sideNav').toggleClass('active-nav');
    e.preventDefault();
  });

  <%# 切換分頁 %>
  $("li a[href='#hot'], li a[href='#all'], li a[href='#school'], li a[href='#student'], li a[href='#dorm'], li a[href='#other']").on('click', function(event) {
    // Prevent default anchor click behavior
    event.preventDefault();
    // Store hash
    var hash = this.hash;
    if (hash === "#hot") {
      console.log('hot');
      $('div.qa-hot').fadeIn(500);
      $('div.qa-all').hide();

    } else if (hash === "#all") {
      $('div.qa-hot').hide();
      $('div.qa-all').hide().fadeIn(500);
      $('.qa-school').show();
      $('.qa-student').show();
      $('.qa-dorm').show();
      $('.qa-other').show();
      $('#title-all').show();
      $('#title-school').hide();
      $('#title-student').hide();
      $('#title-dorm').hide();
      $('#title-other').hide();

    } else if (hash === "#school") {
      $('div.qa-hot').hide();
      $('div.qa-all').hide().fadeIn(500);
      $('tr.qa-school').show();
      $('tr.qa-student').hide();
      $('tr.qa-dorm').hide();
      $('tr.qa-other').hide();
      $('#title-all').hide();
      $('#title-school').show();
      $('#title-student').hide();
      $('#title-dorm').hide();
      $('#title-other').hide();

    } else if (hash === "#student") {
      $('div.qa-hot').hide();
      $('div.qa-all').hide().fadeIn(500);
      $('tr.qa-school').hide();
      $('tr.qa-student').show();
      $('tr.qa-dorm').hide();
      $('tr.qa-other').hide();
      $('#title-all').hide();
      $('#title-school').hide();
      $('#title-student').show();
      $('#title-dorm').hide();
      $('#title-other').hide();

    } else if (hash === "#dorm") {
      $('div.qa-hot').hide();
      $('div.qa-all').hide().fadeIn(500);
      $('tr.qa-school').hide();
      $('tr.qa-student').hide();
      $('tr.qa-dorm').show();
      $('tr.qa-other').hide();
      $('#title-all').hide();
      $('#title-school').hide();
      $('#title-student').hide();
      $('#title-dorm').show();
      $('#title-other').hide();

    } else if (hash === "#other") {
      $('div.qa-hot').hide();
      $('div.qa-all').hide().fadeIn(500);
      $('tr.qa-school').hide();
      $('tr.qa-student').hide();
      $('tr.qa-dorm').hide();
      $('tr.qa-other').show();
      $('#title-all').hide();
      $('#title-school').hide();
      $('#title-student').hide();
      $('#title-dorm').hide();
      $('#title-other').show();
    }
    window.location.hash = hash;
  });

  <%# 當問題被點擊的時候，傳送 xhr 到後端 api，api 會回傳物件包含標題、問題、答案 %>
  $('.clickable').on('click', function() {
    <%# api_token === Qna._id %>
    var id = this.id.split('-')[0];
    $.ajax({
      method: 'GET',
      url: '/qna/' + id
    }).done(function(res) {
      <%# 設定 modal 內容 %>
      document.getElementById('show-title').innerHTML = res.title;
      document.getElementById('show-content').innerHTML = res.content;
      document.getElementById('show-answer').innerHTML = res.answer;

      $('#show-modal').modal('show');
      <%# 當成功顯示之後，動態增加瀏覽次數 %>
      var objs = $('.' + id).find('.view');
      for (var i = 0; i < objs.length; i++) {
        objs[i].innerHTML = parseInt(objs[i].innerHTML) + 1;
      }
    }).fail(function(err) {
      alert('發生不知明錯誤');
    });
  });

  <% if (user && user.local.accountType==='admin') { %>

    <%# CKEDITOR %>
    CKEDITOR.replace('admin-answer-answer',{
      filebrowserUploadUrl: '/uploader',
    });
    CKEDITOR.editorConfig = function (config){
      config.enterMode = CKEDITOR.ENTER_BR;
      config.autoParagraph = false;
    };

    <%# 管理員回答 %>
    $('.admin-answer').on('click', function() {

      var id = this.id.split('-')[0];
      var obj = $('tr.admin-answer.' + id);
      <%# 設定 modal 內容 %>
      $('#admin-answer-form').attr({ 'action': ('/qna/answer/' + id) });
      $('#btn-admin-delete-answer').attr({ 'data-id' : id });
      document.getElementById('admin-answer-title').value = obj.find('.title').text();
      document.getElementById('admin-answer-content').value = obj.find('.content').val();
      // document.getElementById('admin-answer-answer').value = "";
      CKEDITOR.instances['admin-answer-answer'].setData('');
      document.getElementById('admin-answer-type').value = obj.find('.type').val();
      $('#modal-admin-answer').modal('show');

    });

    <%# 管理員修改 %>
    $('.btn-admin-update-answer').on('click', function() {

      var id = this.id.split('-')[0];
      $.ajax({
        method: 'GET',
        url: '/qna/admin/' + id
      }).done(function(res) {
        $('#admin-answer-form').attr({ 'action': ('/qna/answer/' + id) });
        $('#btn-admin-delete-answer').attr({ 'data-id' : id });
        document.getElementById('admin-answer-title').value = res.title;
        document.getElementById('admin-answer-content').value = res.content;
        CKEDITOR.instances['admin-answer-answer'].setData(res.answer);
        document.getElementById('admin-answer-type').value = res.type;

        $('#modal-admin-answer').modal('show');

        $('#show-modal').modal('hide');

      }).fail(function(err) {
        alert('發生不知明錯誤');
      });
    });

    <%# 管理員刪除 %>
    $('#btn-admin-delete-answer').on('click', function() {
      if (confirm("確定要刪除嗎？？？")) {
        $.ajax({
          method: 'POST',
          url: '/qna/deleteByAdmin/' + $(this).attr('data-id')
        }).done(function(res) {
          alert('刪除成功');
          $('#modal-admin-answer').modal('hide');
          $('.' + res.id).remove();
        }).fail(function(err) {
          alert('發生錯誤: ' + err);
        })
      }
    });
  <% } %>
});
</script>