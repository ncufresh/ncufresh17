<!-- jQuery (necessary for Bootstrap's JavaScript plugins) -->
<script src="https://ajax.googleapis.com/ajax/libs/jquery/1.12.4/jquery.min.js"></script>
<!-- Include all compiled plugins (below), or include individual files as needed -->
<!-- <script src="/bootstrap-3.3.7-dist/js/bootstrap.min.js"></script> -->
<script src="https://ajax.googleapis.com/ajax/libs/jqueryui/1.11.4/jquery-ui.min.js" type="text/javascript"></script>
<script>
$(document).ready(function(){
    $('[data-toggle="tooltip"]').tooltip();
    $('select').css({
        'padding' : '0px'
    });
    $('.delete_build').click(function(){
        if(confirm("確定要刪除?")){
            var id = $(this).val();
            $.ajax({
                url:    '/campus/delete/'+ id,
                type:   'GET',
                error: function(e){
                    console.log("ERR  :"+e);
                },
                success: function(data){
                    $('#b'+ id).remove();
                }
            });
        }
    })
    $('.edit_build').click(function(){
        var id = $(this).val();
        $.ajax({
            url:    "/campus/newData/"+id,
            error: function(e){
                console.log("ERR  :"+e);
            },
            success: function(data){
                $("#bid").val(data._id);
                $("#name").val(data.name);
                $("#type").val(data.type);
                $("#SOS").val(data.SOS?1:0);
                $("#AED").val(data.AED?1:0);
                CKEDITOR.instances['content'].setData(data.content);
                $("#btn_save").val("update");
                $("#add_build_modal").modal("show");
            }

        });
    })

    $('.edit_img').click(function(){
         $("#img_body").empty();
        var id=$(this).val();
        $("#imgid").val(id);        
        $.ajax({
            url:    "/campus/get_img/"+id,
            error: function(e){
                console.log("ERR  :"+e);
            },
            success: function(data){
                console.log(data)
                for(var i in data){
                    $("#img_body").append('<div id="'+ 'img'+ data[i]._id +'">'+
                                            '<img src= "' +data[i].img_path+'"' + 'width="100%"' + '>'+'\n'+
                                            '<button class="btn delete_img btn-success" value ="'+data[i]._id +'">'+'刪除圖片'+'</button>'+
                                            '</div>' )
                }
            }
        })
        $("#img_preview_modal").modal("show");
    })

    $('.edit_mapObj').click(function(){
        var id = $(this).val();
        $("#building_img").css({
            "height":"auto",
            "width":$(this).parentsUntil('tr').siblings('.build_size').text()+'%'
        });
        $('#building_img').attr('src',$(this).parentsUntil('tr').siblings('.build_img').children('img').attr('src')).css({
            left: $(this).parentsUntil('tr').siblings('.build_x').text()+"%",
            top:$(this).parentsUntil('tr').siblings('.build_y').text()+"%"
        });
        if($(this).parentsUntil('tr').siblings('.build_SOS').text()==="true"){
            $('#SOSimg').css({
                height:"auto",
                display:"block",
                left: $(this).parentsUntil('tr').siblings('.build_SOSx').text()+"%",
                top:$(this).parentsUntil('tr').siblings('.build_SOSy').text()+"%"
            });
        }
        if($(this).parentsUntil('tr').siblings('.build_AED').text()==="true"){
            $('#AEDimg').css({
                height:"auto",
                display:"block",
                left: $(this).parentsUntil('tr').siblings('.build_AEDx').text()+"%",
                top:$(this).parentsUntil('tr').siblings('.build_AEDy').text()+"%"
            });
        }
        $('#mapObj_id').val(id);
        $('#mapObj_title').text("編輯"+$(this).parentsUntil('tr').siblings('.build_name').text());
        $('#x-position').val( $(this).parentsUntil('tr').siblings('.build_x').text());
        $('#y-position').val( $(this).parentsUntil('tr').siblings('.build_y').text());
        $('#size').val( $(this).parentsUntil('tr').siblings('.build_size').text());
        $('#edit_mapObj_modal').modal();
    })

    $(document).on('click','.delete_img',function(){
        if(confirm("確定要刪除?")){
            var id = $(this).val();
            $.ajax({
                url:    '/campus/delete_img/'+ id,
                type:   'GET',
                error: function(e){
                    console.log("ERR  :"+e);
                },
                success: function(data){
                    $('#img'+ id).remove();
                }
            });
        }
    })

    $(document).on('click','.delete_mapObj',function(){
        if(confirm("確定要刪除?")){
            var id = $(this).val();
            $.ajax({
                url:    '/campus/delete_mapObj/'+ id,
                type:   'GET',
                error: function(e){
                    console.log("ERR  :"+e);
                },
                success: function(data){
                    $('#mapObj'+ id).remove();
                }
            });
        }
    })

    $('#uploadImg').click(function(){
        var formData = new FormData($("#img_form")[0]);
        $.ajax({
            url: "/campus/imgUpload",
            type: 'POST',
            data: formData,
            datatype: 'json',
            processData: false,
            contentType: false,
            enctype: 'multipart/form-data',
            success: function(data){
                console.log(data);
                $("#img_body").append('<div id="'+ 'img'+ data._id +'">'+
                                            '<img src= "' +data.img_path+'"' + 'width="100%"' + '>'+'\n'+
                                            '<button class="btn delete_img btn-success" value ="'+data._id +'">'+'刪除圖片'+'</button>'+
                                            '</div>' )
            },
            error: function(e){
                console.log(e);
            }
        });
    })

    $(".mouse-animate").mouseenter(function(){
        $(this).animate({
            padding:'0vh'
        }, 100);
    });
    $(".mouse-animate").mouseleave(function(){
        $(this).animate({
            padding:'1vh'
        }, 100);
    });
    $(".map-animate").mouseenter(function(){
        $(this).animate({
            padding:'0vh'
        },100);
    });
    $(".map-animate").mouseleave(function(){
        $(this).animate({
            padding:'0.5vh'
        },100);
    });
    $("#building_img").draggable({
        stop: function(){
            var x=$("#building_img").css("left").substring(0,$("#building_img").css("left").length-2)/$("#editmap").width()*100;
            var y=$("#building_img").css("top").substring(0,$("#building_img").css("top").length-2)/$("#editmap").height()*100;
            $('#x-position').val(x);
            $('#y-position').val(y);
        }
    });
    $("#SOSimg").draggable({
        stop: function(){
            var x=$("#SOSimg").css("left").substring(0,$("#SOSimg").css("left").length-2)/$("#editmap").width()*100;
            var y=$("#SOSimg").css("top").substring(0,$("#SOSimg").css("top").length-2)/$("#editmap").height()*100;
            $('#SOSx').val(x);
            $('#SOSy').val(y);
        }
    });
    $("#AEDimg").draggable({
        stop: function(){
            var x=$("#AEDimg").css("left").substring(0,$("#AEDimg").css("left").length-2)/$("#editmap").width()*100;
            var y=$("#AEDimg").css("top").substring(0,$("#AEDimg").css("top").length-2)/$("#editmap").height()*100;
            $('#AEDx').val(x);
            $('#AEDy').val(y);
        }
    });
    $("#size,#x-position,#y-position").change(function(){
        $("#building_img").css({
            "height":"auto",
            "width":$("#size").val()+"%",
            "top":$("#y-position").val()+"%",
            "left":$("#x-position").val()+"%"
        });
    })

    $(".navbar").css({
        "margin-bottom": "0px"
    });
    $(".type-menu").mouseenter(function(){
        if($(this).hasClass("no-animate")) return;
        var now=$(this).attr("alt");
        $(".map-build").stop(false,true);
        $(".map-build."+now).css("display","block").animate({
            opacity:1
        },200);
        $(".map-build."+now).tooltip("show");
        $(".map-build").not("."+now).animate({
            opacity:0
        },200,function(){
            $(".map-build").not("."+now).css("display","none")
        });
    });
    $(".type-menu").mouseleave(function(){
        if($(this).hasClass("no-animate")) return;
        var now=$(this).attr("alt");
        $(".map-build").stop(false,true);
        $(".map-build").not("."+now).css("display","block").animate({
            opacity:1
        },200);
        $(".map-build."+now).tooltip("hide");
    })
    $(".type-menu").click(function(){
        var now=$(this).attr("alt");
        $(".type-menu").addClass("no-animate");
        $('[data-toggle="tooltip"]').tooltip("hide");
        $(".type-menu, #type-title").stop(false,true);
        $(".type-menu").fadeOut(300);  
        $("#type-title").attr("src",$(this).attr("src"))
                        .attr("alt",now).fadeIn(1000);
        $("#map-left").animate({
            "width":"20%",
        },500,function(){
            $("#"+now).slideDown(500);
        });
        $("#main-map").animate({
            "margin-top":"3%",
            "width":"65%",
            "padding-bottom":"36.4%"
        },500);
        $("#map-right").animate({
            "width":"15%",
        },500);
    });
    $("#type-title").click(function(){
        var now=$(this).attr("alt");
        $("*").stop(false,true);
        $("#"+now).slideUp(500,function(){
            $("#type-title").fadeOut(300);
            $("#map-left").animate({
                "width":"10%",
            },500,function(){
                $(".type-menu").fadeIn(300);
                $(".type-menu").removeClass("no-animate");
            });
            $("#main-map").animate({
                "margin-top":"0%",
                "width":"80%",
                "padding-bottom":"44.8%"
            },500);
            $("#map-right").animate({
                "width":"10%",
            },500);
            $(".map-build").stop(false,true);
            $(".map-build").not("."+now).css("display","block").animate({
                opacity:1
            },300);
        });
        
    });
    $(".build-name").mouseenter(function(){
        console.log($(this).attr("value"));
        $("#mapimg"+$(this).attr("value")).animate({
            padding:'0vh'
        }, 100);
        $("#mapimg"+$(this).attr("value")).tooltip("show");
    })
    $(".build-name").mouseleave(function(){
        console.log($(this).attr("value"));
        $("#mapimg"+$(this).attr("value")).animate({
            padding:'0.5vh'
        }, 100);
        $("#mapimg"+$(this).attr("value")).tooltip("hide");
    })
    $(".help-menu").mouseenter(function(){
        $("."+$(this).attr("alt")).animate({
            padding:'0vh'
        }, 100);
        $("."+$(this).attr("alt")).tooltip("show");
    })
    $(".help-menu").mouseleave(function(){
        $("."+$(this).attr("alt")).animate({
            padding:'0.5vh'
        }, 100);
        $("."+$(this).attr("alt")).tooltip("hide");
    })
})
</script>


<script src="/javascript/ckeditor/ckeditor.js"></script>

<script type="text/javascript">
  CKEDITOR.replace('content',{
    filebrowserUploadUrl: '/uploader',
  });
  CKEDITOR.editorConfig = function (config){
      config.enterMode = CKEDITOR.ENTER_BR;
      config.autoParagraph = false;
  };
</script>
